# 2.1 이 장의 내용

이 장에서는 카프카의 메시지 송수신 구조와 카프카를 이용하는 데 알아야 할 기본 용어를 설명한다. <br>카프카는 여러 구성 요소로 이루어져 있어 개별 구성 요소를 파악하는 것만으로는 전체적인 그림을 이해하는 것을 어렵다. 개요부터 시작하여 내부 동작까지 단계적으로 설명한다. 주요내용은 다음과 같다.

    1. 메시지 송수신 기본
    2. 시스템 구성
    3. 분산 메시징을 위한 구조
    4. 데이터 견고함을 담보하는 복제의 구조

## 2.2 메시지 송수신 기본

우선 논리적 구성과 기본 용어를 파악해보자. 카프카의 주요 구성요소는 다음 5가지다.

- 브로커

  - 데이터를 수신, 전달하는 서비스

- 메시지

  - 카프카에서 다루는 데이터의 최소 단위. 카프카가 중계하는 로그의 한 줄 한줄과 센서 데이터 등이 이에 해당. 메시지는 Key와 Value를 갖게 되며 나중에 언급할 메시지 전송할 때 파티셔닝에 이용

- 프로듀서
  - 데이터의 생산자이며 브로커에 메시지를 보내는 애플리케이션
- 컨슈머

  - 브로커에서 메시지를 취득하는 애플리케이션

- 토픽
  - 메시지를 종류(토픽)별로 관리하는 스토리지. 브로커에 배치되어 관리된다. 프로듀서와 컨수머는 특정 토픽을 지정하여 메시지를 송수신함으로써 단일 카프카 클러스터에서 여러 종류의 메시지를 중계한다.<br><br>

## 2.3 시스템 구성

### 브로커

브로커는 하나의 서버(또는 인스턴스) 당 하나의 데몬 프로세스로 동작하여 메시지 수신/전달 요청을 받아들인다. 이것을 여러 대의 클러스터로 구성할 수 있으며 브로커(리소스)를 추가함으로써 수신/전달의 처리량 향상(스케일 아웃)이 가능하다.<br>
브로커에서 받은 데이터는 모두 디스크로 내보내기(영속화)가 이루어져 디스크의 총 용량에 따라 장기간 데이터를 보존할 수 있다.<br><br>

### 프로듀서 API/컨수머 API

프로듀서/컨수머를 구현하는 기능은 브로커로 데이터를 보내고 브로커에서 데이터를 받기 위한 '라이브러리'로 제공된다. 프로듀서를 구현하기 위한 API를 프로듀서 API, 컨수머를 구현하기 위한 API를 컨수머 API라고 한다. 프로듀서, 컨수머는 브로커처럼 서비스(데몬 프로세스)로 작동하는 프로그램이 아니다. 각각의 API는 자바로 제공된다.<br><br>

### 프로듀서

프로듀서는 프로듀서 API를 이용하여 브로커에 데이터를 송신하기 위해 구현된 애플리케이션이다. 실제 사례로는 각종 로그 전송 및 미들웨어와 연동하여 동작하기 때문에 프로듀서 API를 내포한 도구, 미들웨어를 통해 이용하는 형태 등 다양하다.<br>
실제로 프로듀서 기능을 내장하거나 서드 파티의 플러그인 제휴를 통해 제공하는 OSS(Open Source Software), 도구의 종류는 다음과 같다.<br>

- Apache Log4j(Kafka Appender)

  - 로그 출력시 사용하는 자바 기반 로깅 유틸리티 소프트웨어
  - Kafka Appender

- Apache Flume

  - 다량의 로그 데이터를 효율적으로 수집, 취합, 이동하기 위한 분산형 소프트웨어
  - Kafka Sink

- Fluentd

  - 크로스 플랫폼 오픈소스 데이터 수집 소프트웨어
  - fluent-plugin-kafka

- Logstash
  - 일래스틱에서 제공하는 OSS 데이터 수집 엔진
  - logstash-output-kafka

### 컨수머

컨수머 API를 이용해 브로커에서 메시지를 취득하도록 구현된 애플리케이션이다. 브로커는 앞서 말한 대로 메시지를 디스크에 영속화하기 위해 브로커에 도달하는 즉시 컨수머에서 취득해야 하는 제약이 없어 디스크에 보관되어 있는 동안은 메시지 취득이 가능하다. 일정 기간 데이터를 축적한 스토리지에서의 데이터 추출 및 실시간 처리를 위한 애플리케이션의 데이터 입력 등으로 이용된다.<br><br>
프로듀서와 마찬가지로 카프카 연계를 위한 컨수머 기능을 갖춘 기존 제품도 많이 존재한다. 특히 Apache Spark(Streaming), Apache Storm, Apache Flink 등의 분산 스트림 처리 OSS에서는 카프카가 갖춘 확장성을 유용하게 사용할 경우가 많기 때문에 표준 라이브러리로 제공되고 있다.

### 주키퍼

카프카의 브로커에 있어 분산 처리를 위한 관리 도구로 아파치 주키퍼가 필요하다. 주키퍼는 하둡 등 병렬 분산 처리용 OSS에 있어서 설정 관리, 이름 관리, 동기화를 위한 잠금 관리를 하는 구조로 자주 사용된다. 카프카에 있어서는 분산 메시징의 메타데이터(토픽과 파티션 등)를 관리하기 위한 구성 요소로 기능한다. 주키퍼 클러스터(주키퍼 앙상블)의 구조상 3, 5처럼 홀수로 구성하는 것이 일반적이다.

### 카프카 클라이언트

토픽 작성 등 카프카의 동작 및 운영 상에 필요한 조작을 실행하는 서버다. 메시지의 송수신을 처리하는 서버가 아니다.

### 카프카 클러스터

위에서 언급한 바와 같이 카프카는 여러 대의 브로커 서버, 주키퍼 서버로 이루어진 클러스터링의 메시지 중계 기능과 메시지 송수신을 위한 라이브러리 그룹(프로듀서API/컨수머API)으로 구성된다. 이 책에서는 설명을 위해 전자의 브로커, 주키퍼에 의해 구성된 클러스터 시스템을 **카프카 클러스터**라고 정의한다.

## 2.4 분산 메시징을 위한 구조
